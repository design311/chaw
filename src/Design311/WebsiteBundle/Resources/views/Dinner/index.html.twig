{% extends 'Design311WebsiteBundle::layout.html.twig' %}

{% block content %}

<div id="map" class="map"></div>

<div class="content">
	<div class="container">
		<div class="one-third filters">
		<p><a href="{{ path('design311website_dinners_add') }}" class="button button-orange adddinner"><i class="sprite plus white"></i>Dinner toevoegen</a></p>
			<p><strong>Filter de zoekresultaten</strong></p>
			<p><label for="locatie"><strong>Locatie</strong></label></p>
			<p><input type="text" id="locatie"></p>
			<p>TIP: Versleep de kaart om te filteren</p>
			<div id="filters">
			<p>
				<label for="amount">Maximumprijs:</label> â‚¬<span class="amount"></span>
				<input type="hidden" class="amount" id="maxprice">
			</p>
			<div id="slider-range"></div>
			{% for filter in filters %}
				<p><strong>{{filter.name}}</strong></p>
				{% for child in filter.children %}
						<p><input type="checkbox" name="{{filter.name|lower}}" value="{{child.value|lower}}" id="{{child.value|lower}}"> <label for="{{child.value|lower}}">{{child.value}}</label></p>
				{% endfor %}
			{% endfor %}
			</div>
		</div>
		<div class="two-third">
		<table id="dinners" class="dinners">
			<thead>
				<tr>
					<th>Datum</th>
					<th>Titel</th>
					<th>Plaats</th>
					<th>Prijs</th>
					<th>&nbsp;</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td colspan="30"><img src="{{ asset('bundles/design311website/img/loader.gif') }}" alt="Loading..." width="16" height="16"></td>
				</tr>
			</tbody>
		</table>
		<p id="nonefound">Sorry! Geen dinners gevonden in deze regio.</p>
		</div>
	</div>
</div>
{% endblock %}

{% block footer %}
	<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script src="{{ asset('bundles/design311website/js/maps.markerclusterer.js') }}"></script>
	<script src="{{ asset('bundles/design311website/js/jquery-ui/jquery-ui-1.10.4.slider.min.js') }}"></script>
	<link rel="stylesheet" href="{{ asset('bundles/design311website/js/jquery-ui/jquery-ui-1.10.4.slider.min.css') }}">
	<script type="text/javascript">

		$(function(){
			var dinnersTable = $('#dinners');
			var nonefound = $('#nonefound').hide();
			var tbody = $('#dinners tbody');
			var dinners = {{dinners|serialize|raw}};

			var map;
			var markers = [];
			var geocoder = new google.maps.Geocoder();
			var locations = {{ locations|json_encode|raw }};

			map = new google.maps.Map(document.getElementById('map'), {
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				streetViewControl: false,
				mapTypeControl: false,
				scrollwheel: false
			});
			
			var latlngbounds = new google.maps.LatLngBounds();

			$.each(locations, function(i, item){

				var coords = new google.maps.LatLng(item[0], item[1]);
				
				var marker = new google.maps.Marker({
					map: map,
					position: coords,
					icon: "{{ asset('bundles/design311website/img/marker.png')}}",
					dinnerId: i
				});
				markers.push(marker);
				latlngbounds.extend(coords);
				
			})

			var markerCluster = new MarkerClusterer(map, markers, {
				gridSize: 40
			});
			map.setCenter(latlngbounds.getCenter());
			map.fitBounds(latlngbounds);

			if(navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					var currentPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
					centerLocation(currentPosition);
				});
			}

			function centerLocation(coords){
				var radius = 2500; //meter
				var circle = new google.maps.Circle({
					center: coords,
					radius: radius
				});
				
				map.fitBounds(circle.getBounds());
				map.setCenter(coords);
			}

			//idle fires once instead of bounds_changed firing all the time
			google.maps.event.addListener(map, 'idle', function() {
					displayDinners(dinners);
			});

			function displayDinners(dinners){
				tbody.empty();

				var bounds = map.getBounds();
				var visibleDinners = [];
				for (var i=0; i<markers.length; i++){
					if( bounds.contains(markers[i].getPosition()) ){
						visibleDinners.push(markers[i].dinnerId);
					}
				}

				if (visibleDinners.length !== 0) {
					var detail = '{{ path('design311website_dinners_detail', {'permalink': 'permalink_holder'}) }}'
					var deelnemen = '{{ path('design311website_dinners_participate', {'permalink': 'permalink_holder'}) }}';
					$.each(dinners, function(i, dinner){
						if( bounds.contains(markers[i].getPosition()) ){
							var formattedDate = new Date(dinner.date);
							var d = formattedDate.getDate();
							var m =  formattedDate.getMonth();
							m += 1;  // JavaScript months are 0-11
							var y = formattedDate.getFullYear();
							detailLink = detail.replace('permalink_holder', dinner.permalink);
							deelnemenLink = deelnemen.replace('permalink_holder', dinner.permalink);
							tbody.append(' \
								<tr> \
									<td>'+d+'-'+m+'-'+y+'</td> \
									<td><a href="'+detailLink+'">'+dinner.title+'</a></td> \
									<td>'+dinner.address.city+'</td> \
									<td>'+dinner.price+'</td> \
									<td><a href="'+deelnemenLink+'">Deelnemen</a></td> \
								</tr>')
						}
					})
				}
				else{
					dinnersTable.hide();
					nonefound.show();
				}
			}

			$('#locatie').blur(function(){
				if ($(this).val()) {};

				var address = $(this).val();
				geocoder.geocode( { 'address': address}, function(results, status) {
					if (status == google.maps.GeocoderStatus.OK) {

						var latLng = results[0].geometry.location;
						centerLocation(latLng);
					}
					else {
						//TODO proper error message
						alert('Geocode was not successful for the following reason: ' + status);
					}
				});
			})

			$('#filters input').change(function(){

				var filters = {};
				$.each($('#filters input'), function(index, input) {
					if ($(input).is(':checkbox')) {
						if (input.checked) {
							if (typeof filters[input.name] == 'undefined') {
								filters[input.name] = [];
							}
							filters[input.name].push(input.value);
						};
					}
					else{
						filters[input.id] = input.value;
					}
				});

				console.log(filters);

				$.ajax({
					url: "{{path('design311website_dinners_filter')}}",
					type: "POST",
					data: filters,
					dataType: "JSON",
					success: function (data) {
						console.log(data);
						displayDinners(data);
					}
				});

				
			})
		});
	</script>
{% endblock %}